<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <title>Manage Leave Requests</title>
</head>

<body>
    <div th:replace="~{layout :: layout(~{::section}, ~{::script}, 'leave-manage')}">
        <section>
            <div
                class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Leave Requests Management</h1>
            </div>

            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Employee</th>
                                    <th>Dates</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th>Reviewer</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="req : ${requests}">
                                    <td>
                                        <div class="fw-bold" th:text="${req.employee.name}">John Doe</div>
                                        <small class="text-muted"
                                            th:text="${req.employee.department != null ? req.employee.department.name : 'No Dept'}">IT</small>
                                    </td>
                                    <td>
                                        <div th:text="${req.leaveType}" class="badge bg-secondary mb-1">VACATION</div>
                                        <br>
                                        <small th:text="${req.startDate} + ' to ' + ${req.endDate}"></small>
                                    </td>
                                    <td>
                                        <span th:text="${req.reason}" class="text-truncate d-inline-block"
                                            style="max-width: 200px;">Reason...</span>
                                    </td>
                                    <td>
                                        <span class="badge"
                                            th:classappend="${req.status.name() == 'APPROVED' ? 'bg-success' : (req.status.name() == 'REJECTED' ? 'bg-danger' : 'bg-warning text-dark')}"
                                            th:text="${req.status}">PENDING</span>
                                    </td>
                                    <td>
                                        <small th:if="${req.adminComment != null}">
                                            <div th:text="${req.reviewedBy}">Admin</div>
                                            <i class="text-muted" th:text="${req.adminComment}"></i>
                                        </small>
                                    </td>
                                    <td class="text-end">
                                        <!-- Actions only available if Pending OR if User is Admin (Override) -->
                                        <!-- HR Constraint: Can only edit PENDING -->
                                        <div
                                            th:if="${req.status.name() == 'PENDING' or #authorization.expression('hasRole(''ADMIN'')')}">
                                            <button class="btn btn-sm btn-success me-1" data-bs-toggle="modal"
                                                data-bs-target="#actionModal" th:data-id="${req.id}"
                                                data-action="APPROVED" title="Approve">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" data-bs-toggle="modal"
                                                data-bs-target="#actionModal" th:data-id="${req.id}"
                                                data-action="REJECTED" title="Reject">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr th:if="${requests.isEmpty()}">
                                    <td colspan="6" class="text-center text-muted py-4">No leave requests found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Action Modal -->
            <div class="modal fade" id="actionModal" tabindex="-1">
                <div class="modal-dialog">
                    <form action="/leave/manage/update" method="post">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Confirm Action</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" name="id" id="modalRequestId">
                                <input type="hidden" name="status" id="modalActionStatus">
                                <p id="modalMessage">Are you sure?</p>
                                <div class="mb-3">
                                    <label class="form-label">Comment (Required for Rejection)</label>
                                    <textarea name="comment" class="form-control" rows="2"
                                        placeholder="Reason..."></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Confirm</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <script>
            const actionModal = document.getElementById('actionModal')
            actionModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget
                const id = button.getAttribute('data-id')
                const action = button.getAttribute('data-action')

                const modalRequestId = actionModal.querySelector('#modalRequestId')
                const modalActionStatus = actionModal.querySelector('#modalActionStatus')
                const modalMessage = actionModal.querySelector('#modalMessage')

                modalRequestId.value = id
                modalActionStatus.value = action
                modalMessage.textContent = `Are you sure you want to mark this request as ${action}?`
            })
        </script>
    </div>
</body>

</html>