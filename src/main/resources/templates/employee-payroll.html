<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>My Payslips</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-card-1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .gradient-card-2 {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .gradient-card-3 {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }

        .card {
            border: none;
            border-radius: 12px;
        }

        .card-header-custom {
            background: transparent;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div th:replace="~{layout :: layout(~{::section}, ~{::script}, 'payroll')}">
        <section>
            <div
                class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">My Payslips</h1>
            </div>

            <!-- Financial Insights -->
            <div class="row mb-4">
                <!-- Stats Cards -->
                <div class="col-md-8">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card gradient-card-2 shadow-sm h-100">
                                <div class="card-body p-3">
                                    <h6 class="card-title mb-1"><i class="fas fa-coins me-2"></i>Year to Date</h6>
                                    <h4 class="fw-bold mb-0"
                                        th:text="${'BDT ' + #numbers.formatDecimal(ytdEarnings, 1, 'COMMA', 2, 'POINT')}">
                                        BDT 0.00</h4>
                                    <small class="opacity-75">Net Earnings (This Year)</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card gradient-card-1 shadow-sm h-100">
                                <div class="card-body p-3">
                                    <h6 class="card-title mb-1"><i class="fas fa-gift me-2"></i>Total Bonus</h6>
                                    <h4 class="fw-bold mb-0"
                                        th:text="${'BDT ' + #numbers.formatDecimal(totalBonuses, 1, 'COMMA', 2, 'POINT')}">
                                        BDT 0.00</h4>
                                    <small class="opacity-75">Bonuses Collected</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card gradient-card-3 shadow-sm h-100">
                                <div class="card-body p-3">
                                    <h6 class="card-title mb-1"><i class="fas fa-trophy me-2"></i>Best Month</h6>
                                    <h4 class="fw-bold mb-0" th:text="${bestMonth}">N/A</h4>
                                    <small class="opacity-75">Highest Payout</small>
                                </div>
                            </div>
                        </div>

                        <!-- Chart in Row 2 of Left Col -->
                        <div class="col-12 mt-3">
                            <div class="card shadow-sm h-100">
                                <div class="card-header-custom p-3 bg-light">
                                    <i class="fas fa-chart-line me-2"></i> Income Trend (Last 12 Months)
                                </div>
                                <div class="card-body">
                                    <canvas id="incomeChart" style="max-height: 250px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Payslips / Table Context is below -->
            </div>

            <!-- My Payslips List -->
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Month</th>
                                    <th>Working Days</th>
                                    <th>Present</th>
                                    <th>Leaves (Paid/Unpaid)</th>
                                    <th>Deductions</th>
                                    <th>Net Salary</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="slip : ${payslips}">
                                    <td class="fw-bold" th:text="${slip.month}">2023-12</td>
                                    <td th:text="${slip.totalWorkingDays}">20</td>
                                    <td th:text="${slip.presentDays}">18</td>
                                    <td>
                                        <span class="text-success" th:text="${slip.paidLeaveDays} + ' P'"></span> /
                                        <span class="text-danger" th:text="${slip.unpaidLeaveDays} + ' U'"></span>
                                    </td>
                                    <td class="text-danger">
                                        <span
                                            th:text="${'-BDT ' + #numbers.formatDecimal(slip.deductionAmount, 1, 'COMMA', 2, 'POINT')}">-100.0</span>
                                        <div class="small text-danger"
                                            th:if="${slip.latePenaltyAmount != null and slip.latePenaltyAmount > 0}">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Late Penalty
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-success fs-6"
                                            th:text="${'BDT ' + #numbers.formatDecimal(slip.netSalary, 1, 'COMMA', 2, 'POINT')}">2900.0</span>
                                    </td>
                                    <td>
                                        <span
                                            th:class="${'badge ' + (slip.status.name() == 'PAID' ? 'bg-success' : 'bg-secondary')}"
                                            th:text="${slip.status}">DRAFT</span>
                                    </td>
                                </tr>
                                <tr th:if="${payslips.isEmpty()}">
                                    <td colspan="8" class="text-center text-muted py-4">
                                        No payslip records found.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payslip Modal -->
            <div class="modal fade" id="payslipModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Payslip Preview</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="payslip-container border p-4 rounded bg-white">
                                <!-- Header -->
                                <div class="text-center mb-4">
                                    <h2 class="fw-bold mb-0 text-uppercase" th:text="${companyName}">Company Name</h2>
                                    <p class="text-muted small">Official Payslip</p>
                                </div>

                                <!-- Info Grid -->
                                <div class="row mb-4">
                                    <div class="col-6">
                                        <h6 class="text-uppercase text-secondary small mb-1">Employee</h6>
                                        <div class="fw-bold fs-5" id="psName">John Doe</div>
                                        <div class="small text-muted" id="psRole">Employee</div>
                                    </div>
                                    <div class="col-6 text-end">
                                        <h6 class="text-uppercase text-secondary small mb-1">Pay Period</h6>
                                        <div class="fw-bold fs-5" id="psMonth">2023-12</div>
                                        <div class="small text-muted">Generated Automatically</div>
                                    </div>
                                </div>

                                <!-- Attendance Summary -->
                                <div class="row mb-3 gx-2 text-center text-muted small">
                                    <div class="col border-end">
                                        <div class="fw-bold">Working Days</div>
                                        <div id="psWorkingDays">20</div>
                                    </div>
                                    <div class="col border-end">
                                        <div class="fw-bold text-success">Present</div>
                                        <div id="psPresent">18</div>
                                    </div>
                                    <div class="col">
                                        <div class="fw-bold text-danger">Absent</div>
                                        <div id="psAbsent">2</div>
                                    </div>
                                </div>

                                <!-- Details Section (Split View) -->
                                <div class="row mb-0">
                                    <!-- Earnings Column -->
                                    <div class="col-6 border-end pe-0 ps-0">
                                        <div class="bg-light fw-bold text-uppercase small p-2 border-bottom border-top">
                                            Earnings</div>
                                        <table class="table table-borderless table-sm mb-0">
                                            <tbody>
                                                <tr>
                                                    <td class="ps-3 py-2">Basic Salary</td>
                                                    <td class="text-end pe-3 py-2 fw-bold" id="psBasic">BDT 0.00</td>
                                                </tr>
                                                <tr id="allowanceRow" style="display:none;">
                                                    <td class="ps-3 py-2">Fixed Allowance</td>
                                                    <td class="text-end pe-3 py-2 fw-bold" id="psAllowance">BDT 0.00
                                                    </td>
                                                </tr>
                                                <tr id="bonusRow" style="display:none;">
                                                    <td class="ps-3 py-2">Bonus / OT</td>
                                                    <td class="text-end pe-3 py-2 fw-bold" id="psBonus">BDT 0.00</td>
                                                </tr>
                                                <!-- Spacer to push totals down if needed, or just let it stack -->
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Deductions Column -->
                                    <div class="col-6 ps-0 pe-0">
                                        <div class="bg-light fw-bold text-uppercase small p-2 border-bottom border-top">
                                            Deductions</div>
                                        <table class="table table-borderless table-sm mb-0">
                                            <tbody>
                                                <!-- We don't have specific "Tax" field yet, so we use Total Deductions as base or just show breakdown -->
                                                <!-- Assuming 'deductions' passed is the TOTAL. If we want breakdown, we need components. 
                                                     Currently logic is: deductionAmount = absent + late + advance.
                                                     We should show breakdown if possible, or just "Other Deductions" if we don't have individual.
                                                     
                                                     Actually, the 'deductionAmount' in variable includes EVERYTHING. 
                                                     To show breakdown professionally, we should calculate 'Other/Absent' by subtracting knowns, 
                                                     OR just list Key Deductions and then a 'Total Deductions' line. 
                                                     
                                                     Let's list:
                                                     1. Late Penalty
                                                     2. Advance Salary
                                                     3. Unpaid Leave (Calculated? Or just 'Absent Deduction')
                                                     
                                                     Wait, the current JS passes 'deductionAmount' (Total). 
                                                     We can show "Total Deductions" at bottom of right col?
                                                     Let's try to show breakdown if we can. 
                                                     
                                                        absentDeduction = total - late - advance.
                                                 -->
                                                <tr id="absentRow">
                                                    <td class="ps-3 py-2 text-muted">Absent / Unpaid Leave</td>
                                                    <td class="text-end pe-3 py-2 text-danger" id="psAbsentDed">-</td>
                                                </tr>
                                                <tr id="lateRow" style="display:none;">
                                                    <td class="ps-3 py-2 text-warning">Late Penalty <small
                                                            id="psLateCount" class="text-muted"></small></td>
                                                    <td class="text-end pe-3 py-2 text-warning" id="psLateAmt">-</td>
                                                </tr>
                                                <tr id="advanceRow" style="display:none;">
                                                    <td class="ps-3 py-2 text-info">Advance Salary</td>
                                                    <td class="text-end pe-3 py-2 text-info" id="psAdvanceAmt">-</td>
                                                </tr>
                                                <tr class="border-top">
                                                    <td class="ps-3 py-2 fw-bold">Total Deductions</td>
                                                    <td class="text-end pe-3 py-2 fw-bold text-danger"
                                                        id="psDeductions">BDT 0.00</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Net Pay Row (Full Width) -->
                                <div class="row m-0 bg-light border-top border-bottom border-dark mt-2">
                                    <div class="col-8 p-3 fw-bold text-uppercase text-end align-self-center">Net Payable
                                        Amount</div>
                                    <div class="col-4 p-3 bg-white text-end fw-bold fs-5 border-start" id="psNet">BDT
                                        0.00</div>
                                </div>

                                <!-- Footer -->
                                <div class="row mt-5">
                                    <div class="col-6">
                                        <div class="border-top border-dark w-75 pt-2 text-center">
                                            <small class="text-muted text-uppercase">Employee Signature</small>
                                        </div>
                                    </div>
                                    <div class="col-6 text-end">
                                        <div class="border-top border-dark w-75 ms-auto pt-2 text-center">
                                            <small class="text-muted text-uppercase">Authorized Signature</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer" style="z-index: 1060; position: relative;">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-success" onclick="downloadPdf()">Download PDF</button>
                        </div>
                    </div>
                </div>
            </div>

        </section>
        <script>
            function downloadPdf() {
                const element = document.querySelector('.payslip-container');
                const body = document.body;

                // 1. Apply Official Mode to Body (triggers CSS)
                body.classList.add('official-pdf-mode');

                const name = document.getElementById('psName').innerText;
                const month = document.getElementById('psMonth').innerText;

                const opt = {
                    margin: 0.5,
                    filename: `Payslip_${name}_${month}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, scrollX: 0, scrollY: 0 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                // 2. Generate and Revert
                html2pdf().set(opt).from(element).save().then(() => {
                    body.classList.remove('official-pdf-mode');
                }).catch(err => {
                    console.error(err);
                    body.classList.remove('official-pdf-mode');
                });
            }

            function showPayslipModal(name, month, basic, ded, net, working, present, absent, lateDays, lateAmt, allowance, bonus, advance) {
                document.getElementById('psName').innerText = name;
                document.getElementById('psMonth').innerText = 'Month: ' + month;

                const fmt = (val) => 'BDT ' + new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val);

                document.getElementById('psBasic').innerText = fmt(basic);
                document.getElementById('psDeductions').innerText = '-' + fmt(ded);
                document.getElementById('psNet').innerText = fmt(net);

                // Allowances
                if (allowance && parseFloat(allowance) > 0) {
                    document.getElementById('allowanceRow').style.display = 'table-row';
                    document.getElementById('psAllowance').innerText = fmt(allowance);
                } else {
                    document.getElementById('allowanceRow').style.display = 'none';
                }

                // Bonus
                if (bonus && parseFloat(bonus) > 0) {
                    document.getElementById('bonusRow').style.display = 'table-row';
                    document.getElementById('psBonus').innerText = fmt(bonus);
                } else {
                    document.getElementById('bonusRow').style.display = 'none';
                }

                document.getElementById('psWorkingDays').innerText = working;
                document.getElementById('psPresent').innerText = present;
                document.getElementById('psAbsent').innerText = absent;

                // Calculate Specific Deductions
                let totalDed = parseFloat(ded) || 0;
                let latePenalty = parseFloat(lateAmt) || 0;
                let advanceDed = parseFloat(advance) || 0;
                let absentDed = totalDed - latePenalty - advanceDed;

                // Absent/Other Deduction Row
                if (absentDed > 0.01) { // Tolerance for float
                    document.getElementById('absentRow').style.display = 'table-row';
                    document.getElementById('psAbsentDed').innerText = '-' + fmt(absentDed);
                } else {
                    document.getElementById('absentRow').style.display = 'none';
                }

                // Late Logic
                if (latePenalty > 0) {
                    document.getElementById('lateRow').style.display = 'table-row';
                    document.getElementById('psLateCount').innerText = '(' + lateDays + ' days)';
                    document.getElementById('psLateAmt').innerText = '-' + fmt(latePenalty);
                } else {
                    document.getElementById('lateRow').style.display = 'none';
                }

                // Advance Salary Logic
                if (advanceDed > 0) {
                    document.getElementById('advanceRow').style.display = 'table-row';
                    document.getElementById('psAdvanceAmt').innerText = '-' + fmt(advanceDed);
                } else {
                    document.getElementById('advanceRow').style.display = 'none';
                }

                new bootstrap.Modal(document.getElementById('payslipModal')).show();
            }
        </script>

        <!-- Chart Config -->
        <script th:inline="javascript">
            /*<![CDATA[*/
            var chartLabels = /*[[${chartLabels}]]*/[];
            var chartData = /*[[${chartData}]]*/[];
            /*]]>*/

            document.addEventListener('DOMContentLoaded', function () {
                if (document.getElementById('incomeChart')) {
                    var ctx = document.getElementById('incomeChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                label: 'Net Pay (BDT)',
                                data: chartData,
                                backgroundColor: 'rgba(17, 153, 142, 0.1)', // Matches gradient 2
                                borderColor: '#11998e',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#ffffff',
                                pointBorderColor: '#11998e',
                                pointRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'BDT' }).format(context.parsed.y).replace('BDT', 'BDT ');
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { borderDash: [2, 4], color: 'rgba(0,0,0,0.05)' },
                                    ticks: { font: { size: 10 } }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { size: 10 } }
                                }
                            }
                        }
                    });
                }
            });
        </script>
    </div>
</body>

</html>