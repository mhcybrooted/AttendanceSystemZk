<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>My Payslips</title>
</head>

<body>
    <div th:replace="~{layout :: layout(~{::section}, ~{::script}, 'payroll')}">
        <section>
            <div
                class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">My Payslips</h1>
            </div>

            <!-- My Payslips -->
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Month</th>
                                    <th>Working Days</th>
                                    <th>Present</th>
                                    <th>Leaves (Paid/Unpaid)</th>
                                    <th>Deductions</th>
                                    <th>Net Salary</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="slip : ${payslips}">
                                    <td class="fw-bold" th:text="${slip.month}">2023-12</td>
                                    <td th:text="${slip.totalWorkingDays}">20</td>
                                    <td th:text="${slip.presentDays}">18</td>
                                    <td>
                                        <span class="text-success" th:text="${slip.paidLeaveDays} + ' P'"></span> /
                                        <span class="text-danger" th:text="${slip.unpaidLeaveDays} + ' U'"></span>
                                    </td>
                                    <td class="text-danger">
                                        <span th:text="${'-' + slip.deductionAmount}">-100.0</span>
                                        <div class="small text-danger"
                                            th:if="${slip.latePenaltyAmount != null and slip.latePenaltyAmount > 0}">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Late Penalty
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-success fs-6" th:text="${slip.netSalary}">2900.0</span>
                                    </td>
                                    <td>
                                        <span
                                            th:class="${'badge ' + (slip.status.name() == 'PAID' ? 'bg-success' : 'bg-secondary')}"
                                            th:text="${slip.status}">DRAFT</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary"
                                            th:onclick="showPayslipModal([[${slip.employee.name}]], [[${slip.month}]], [[${slip.basicSalary}]], [[${slip.deductionAmount}]], [[${slip.netSalary}]], [[${slip.totalWorkingDays}]], [[${slip.presentDays}]], [[${slip.absentDays}]], [[${slip.lateDays}]], [[${slip.latePenaltyAmount}]], [[${slip.allowanceAmount}]], [[${slip.bonusAmount}]])">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </td>
                                </tr>
                                <tr th:if="${payslips.isEmpty()}">
                                    <td colspan="8" class="text-center text-muted py-4">
                                        No payslip records found.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payslip Modal -->
            <div class="modal fade" id="payslipModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Payslip Preview</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-4">
                            <div class="payslip-container border p-4 rounded bg-white">
                                <!-- Header -->
                                <div class="text-center mb-4">
                                    <h2 class="fw-bold mb-0 text-uppercase" th:text="${companyName}">Company Name</h2>
                                    <p class="text-muted small">Official Payslip</p>
                                </div>

                                <!-- Info Grid -->
                                <div class="row mb-4">
                                    <div class="col-6">
                                        <h6 class="text-uppercase text-secondary small mb-1">Employee</h6>
                                        <div class="fw-bold fs-5" id="psName">John Doe</div>
                                        <div class="small text-muted" id="psRole">Employee</div>
                                    </div>
                                    <div class="col-6 text-end">
                                        <h6 class="text-uppercase text-secondary small mb-1">Pay Period</h6>
                                        <div class="fw-bold fs-5" id="psMonth">2023-12</div>
                                        <div class="small text-muted">Generated Automatically</div>
                                    </div>
                                </div>

                                <!-- Attendance Summary -->
                                <div class="row mb-3 gx-2 text-center text-muted small">
                                    <div class="col border-end">
                                        <div class="fw-bold">Working Days</div>
                                        <div id="psWorkingDays">20</div>
                                    </div>
                                    <div class="col border-end">
                                        <div class="fw-bold text-success">Present</div>
                                        <div id="psPresent">18</div>
                                    </div>
                                    <div class="col">
                                        <div class="fw-bold text-danger">Absent</div>
                                        <div id="psAbsent">2</div>
                                    </div>
                                </div>

                                <!-- Details Table -->
                                <div class="table-responsive mb-4">
                                    <table class="table table-bordered mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="w-50">Earnings</th>
                                                <th class="text-end">Amount</th>
                                                <th class="w-50">Deductions</th>
                                                <th class="text-end">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Basic Salary</td>
                                                <td class="text-end" id="psBasic">$3000.00</td>
                                                <td class="text-danger">Total Deductions</td>
                                                <td class="text-end text-danger" id="psDeductions">-$200.00</td>
                                            </tr>
                                            <tr id="allowanceRow" style="display:none;">
                                                <td>Fixed Allowance</td>
                                                <td class="text-end" id="psAllowance">$0.00</td>
                                                <td></td>
                                                <td></td>
                                            </tr>
                                            <tr id="bonusRow" style="display:none;">
                                                <td>Bonus / OT</td>
                                                <td class="text-end" id="psBonus">$0.00</td>
                                                <td></td>
                                                <td></td>
                                            </tr>
                                            <!-- Late Penalty Dynamic Row -->
                                            <tr id="lateRow" style="display:none;">
                                                <td></td>
                                                <td></td>
                                                <td class="text-warning">Late Penalty <span id="psLateCount"></span>
                                                </td>
                                                <td class="text-end text-warning" id="psLateAmt">-$0.00</td>
                                            </tr>
                                        </tbody>
                                        <tfoot class="table-light">
                                            <tr>
                                                <td colspan="3" class="text-end fw-bold text-uppercase">Net Payable</td>
                                                <td class="text-end fw-bold fs-5 text-dark" id="psNet">$2800.00</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <!-- Footer -->
                                <div class="row mt-5">
                                    <div class="col-6">
                                        <div class="border-top border-dark w-75 pt-2 text-center">
                                            <small class="text-muted text-uppercase">Employee Signature</small>
                                        </div>
                                    </div>
                                    <div class="col-6 text-end">
                                        <div class="border-top border-dark w-75 ms-auto pt-2 text-center">
                                            <small class="text-muted text-uppercase">Authorized Signature</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer" style="z-index: 1060; position: relative;">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-success" onclick="downloadPdf()">Download PDF</button>
                        </div>
                    </div>
                </div>
            </div>

        </section>
        <script>
            function downloadPdf() {
                const element = document.querySelector('.payslip-container');
                const body = document.body;

                // 1. Apply Official Mode to Body (triggers CSS)
                body.classList.add('official-pdf-mode');

                const name = document.getElementById('psName').innerText;
                const month = document.getElementById('psMonth').innerText;

                const opt = {
                    margin: 0.5,
                    filename: `Payslip_${name}_${month}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, scrollX: 0, scrollY: 0 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                // 2. Generate and Revert
                html2pdf().set(opt).from(element).save().then(() => {
                    body.classList.remove('official-pdf-mode');
                }).catch(err => {
                    console.error(err);
                    body.classList.remove('official-pdf-mode');
                });
            }

            function showPayslipModal(name, month, basic, ded, net, working, present, absent, lateDays, lateAmt, allowance, bonus) {
                document.getElementById('psName').innerText = name;
                document.getElementById('psMonth').innerText = 'Month: ' + month;

                const fmt = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val);

                document.getElementById('psBasic').innerText = fmt(basic);
                document.getElementById('psDeductions').innerText = '-' + fmt(ded); // Ded is already positive double usually, display as negative
                document.getElementById('psNet').innerText = fmt(net);

                // Allowances
                if (allowance && parseFloat(allowance) > 0) {
                    document.getElementById('allowanceRow').style.display = 'table-row';
                    document.getElementById('psAllowance').innerText = fmt(allowance);
                } else {
                    document.getElementById('allowanceRow').style.display = 'none';
                }

                // Bonus
                if (bonus && parseFloat(bonus) > 0) {
                    document.getElementById('bonusRow').style.display = 'table-row';
                    document.getElementById('psBonus').innerText = fmt(bonus);
                } else {
                    document.getElementById('bonusRow').style.display = 'none';
                }

                document.getElementById('psWorkingDays').innerText = working;
                document.getElementById('psPresent').innerText = present;
                document.getElementById('psAbsent').innerText = absent;

                // Late Logic
                if (lateAmt && parseFloat(lateAmt) > 0) {
                    document.getElementById('lateRow').style.display = 'table-row';
                    document.getElementById('psLateCount').innerText = '(' + lateDays + ' days)';
                    document.getElementById('psLateAmt').innerText = '-' + fmt(lateAmt);
                } else {
                    document.getElementById('lateRow').style.display = 'none';
                }

                new bootstrap.Modal(document.getElementById('payslipModal')).show();
            }
        </script>
    </div>
</body>

</html>