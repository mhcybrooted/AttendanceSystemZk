<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Employee Management</title>
</head>

<body>
    <div th:replace="~{layout :: layout(~{::section}, ~{::script}, 'employees')}">
        <section>
            <div class="container-fluid">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h2>Employees</h2>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown"
                                aria-expanded="false" id="bulkActionsBtn" disabled>
                                Bulk Actions
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="openBulkAssignModal()">Assign
                                        Department</a></li>
                            </ul>
                        </div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
                            + Add Employee
                        </button>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th><input type="checkbox" id="selectAll" onclick="toggleAll(this)"></th>
                                        <th>Photo</th>
                                        <th>
                                            <a class="text-white text-decoration-none"
                                                th:href="@{/employees(sortField='id', sortDir=${sortField == 'id' ? reverseSortDir : sortDir})}">
                                                ID (Device ID)
                                                <span th:if="${sortField == 'id'}"
                                                    th:text="${sortDir == 'asc' ? '▲' : '▼'}"></span>
                                            </a>
                                        </th>
                                        <th>
                                            <a class="text-white text-decoration-none"
                                                th:href="@{/employees(sortField='name', sortDir=${sortField == 'name' ? reverseSortDir : sortDir})}">
                                                Name
                                                <span th:if="${sortField == 'name'}"
                                                    th:text="${sortDir == 'asc' ? '▲' : '▼'}"></span>
                                            </a>
                                        </th>
                                        <th>
                                            <a class="text-white text-decoration-none"
                                                th:href="@{/employees(sortField='department', sortDir=${sortField == 'department' ? reverseSortDir : sortDir})}">
                                                Department
                                                <span th:if="${sortField == 'department'}"
                                                    th:text="${sortDir == 'asc' ? '▲' : '▼'}"></span>
                                            </a>
                                        </th>
                                        <th>
                                            <a class="text-white text-decoration-none"
                                                th:href="@{/employees(sortField='role', sortDir=${sortField == 'role' ? reverseSortDir : sortDir})}">
                                                Role
                                                <span th:if="${sortField == 'role'}"
                                                    th:text="${sortDir == 'asc' ? '▲' : '▼'}"></span>
                                            </a>
                                        </th>
                                        <th>
                                            <a class="text-white text-decoration-none"
                                                th:href="@{/employees(sortField='email', sortDir=${sortField == 'email' ? reverseSortDir : sortDir})}">
                                                Email
                                                <span th:if="${sortField == 'email'}"
                                                    th:text="${sortDir == 'asc' ? '▲' : '▼'}"></span>
                                            </a>
                                        </th>
                                        <th>Quota</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="emp : ${employees}">
                                        <td><input type="checkbox" class="emp-checkbox" th:value="${emp.id}"
                                                onclick="updateBulkBtn()"></td>
                                        <td>
                                            <img th:if="${emp.photoBase64 != null}"
                                                th:src="'data:image/jpeg;base64,' + ${emp.photoBase64}" width="50"
                                                height="50" class="rounded-circle" style="object-fit:cover;">
                                            <span th:if="${emp.photoBase64 == null}" class="text-muted">No IMG</span>
                                        </td>
                                        <td th:text="${emp.id}">1</td>
                                        <td>
                                            <span th:text="${emp.name}">John Doe</span>
                                            <span th:if="${emp.isGuest}"
                                                class="badge bg-info text-dark ms-1">Guest</span>
                                        </td>
                                        <td th:text="${emp.department != null ? emp.department.name : 'Unassigned'}">
                                            Engineering
                                        </td>
                                        <td th:text="${emp.role}">Developer</td>
                                        <td th:text="${emp.email}">john@example.com</td>
                                        <td>
                                            <span th:if="${emp.annualLeaveQuota != null}"
                                                th:text="${emp.annualLeaveQuota}">20</span>
                                            <span th:if="${emp.annualLeaveQuota == null}"
                                                class="badge bg-secondary">Default</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-warning btn-sm me-1" type="button"
                                                th:data-id="${emp.id}" th:data-name="${emp.name}"
                                                th:data-role="${emp.role}" th:data-email="${emp.email}"
                                                th:data-dept-id="${emp.department != null ? emp.department.id : ''}"
                                                th:data-quota="${emp.annualLeaveQuota}"
                                                th:data-is-guest="${emp.isGuest}"
                                                th:data-joining-date="${emp.joiningDate}" onclick="editEmployee(this)">
                                                Edit
                                            </button>
                                            <a th:href="@{/employees/delete/{id}(id=${emp.id})}"
                                                class="btn btn-danger btn-sm"
                                                onclick="return confirm('Delete this employee?')">Delete</a>
                                        </td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(employees)}">
                                        <td colspan="6" class="text-center">No employees found. Add one to link names to
                                            attendance
                                            logs.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div th:replace="fragments/pagination :: pagination(page=${page}, baseUrl='/employees')"></div>
                </div>

                <!-- Add/Edit Employee Modal -->
                <div class="modal fade" id="addEmployeeModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form action="/employees" method="post">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="empModalTitle">Add Employee</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Device User ID (PIN)</label>
                                        <input type="text" class="form-control" id="empId" name="id" required
                                            placeholder="Important! Must match Device ID">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="empName" name="name"
                                            placeholder="John Doe" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Department</label>
                                        <select name="departmentId" id="empDept" class="form-select">
                                            <option value="">Select Department</option>
                                            <option th:each="dept : ${departments}" th:value="${dept.id}"
                                                th:text="${dept.name}">
                                            </option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Role</label>
                                        <input type="text" class="form-control" id="empRole" name="role"
                                            placeholder="Staff">
                                    </div>
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="empIsGuest" name="guest">
                                        <label class="form-check-label" for="empIsGuest">Is Guest</label>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="empEmail" name="email"
                                            placeholder="john@example.com">
                                    </div>
                                    <div class="mb-3">
                                        <input type="text" class="form-control" id="empUsername" name="username"
                                            placeholder="Set password for employee login">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Annual Leave Quota (Days)</label>
                                        <input type="number" class="form-control" id="empQuota" name="annualLeaveQuota"
                                            placeholder="Leave empty to use Global Default">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Joining Date</label>
                                        <input type="date" class="form-control" id="empJoiningDate" name="joiningDate">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Save Employee</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Assign Dept Modal -->
            <div class="modal fade" id="bulkAssignModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form action="/employees/bulk/assign-department" method="post" id="bulkAssignForm">
                            <div class="modal-header">
                                <h5 class="modal-title">Bulk Assign Department</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Assign selected employees to department:</p>
                                <div class="mb-3">
                                    <select name="departmentId" class="form-select" required>
                                        <option value="">Select Department</option>
                                        <option th:each="dept : ${departments}" th:value="${dept.id}"
                                            th:text="${dept.name}"></option>
                                    </select>
                                </div>
                                <div id="selectedEmployeeInputs"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Assign</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <script>
            function editEmployee(btn) {
                var id = btn.getAttribute('data-id');
                var name = btn.getAttribute('data-name');
                var role = btn.getAttribute('data-role');
                var email = btn.getAttribute('data-email');
                var deptId = btn.getAttribute('data-dept-id');
                var isGuest = btn.getAttribute('data-is-guest') === 'true';
                var joiningDate = btn.getAttribute('data-joining-date');

                document.getElementById('empModalTitle').innerText = 'Edit Employee';
                document.getElementById('empId').value = id;
                document.getElementById('empId').readOnly = true; // Cannot change ID in edit
                document.getElementById('empName').value = name;
                document.getElementById('empRole').value = role;
                document.getElementById('empEmail').value = email;
                document.getElementById('empDept').value = deptId;
                document.getElementById('empQuota').value = btn.getAttribute('data-quota');
                document.getElementById('empIsGuest').checked = isGuest;
                document.getElementById('empJoiningDate').value = joiningDate;
                new bootstrap.Modal(document.getElementById('addEmployeeModal')).show();
            }

            // Reset check (optional, or just rely on manual clear)
            document.getElementById('addEmployeeModal').addEventListener('hidden.bs.modal', function () {
                document.getElementById('empModalTitle').innerText = 'Add Employee';
                document.getElementById('empId').readOnly = false;
                document.getElementById('empId').value = '';
                document.getElementById('empName').value = '';
                document.getElementById('empRole').value = '';
                document.getElementById('empEmail').value = '';
                document.getElementById('empDept').value = '';
                document.getElementById('empIsGuest').checked = false;
                document.getElementById('empQuota').value = '';
                document.getElementById('empJoiningDate').value = '';
                document.getElementById('empUsername').value = ''; // Clear username
            });
            document.getElementById('empModalTitle').innerText = 'Add Employee';
            document.getElementById('empId').readOnly = false;
            document.getElementById('empId').value = '';
            document.getElementById('empName').value = '';
            document.getElementById('empRole').value = '';
            document.getElementById('empEmail').value = '';
            document.getElementById('empRole').value = '';
            document.getElementById('empEmail').value = '';
            document.getElementById('empDept').value = '';
            document.getElementById('empQuota').value = '';

            // Bulk Actions Logic
            function toggleAll(source) {
                var checkboxes = document.getElementsByClassName('emp-checkbox');
                for (var i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked = source.checked;
                }
                updateBulkBtn();
            }

            function updateBulkBtn() {
                var checkboxes = document.getElementsByClassName('emp-checkbox');
                var checkedCount = 0;
                for (var i = 0; i < checkboxes.length; i++) {
                    if (checkboxes[i].checked) checkedCount++;
                }
                var btn = document.getElementById('bulkActionsBtn');
                if (btn) btn.disabled = checkedCount === 0;
            }

            function openBulkAssignModal() {
                var checkboxes = document.getElementsByClassName('emp-checkbox');
                var container = document.getElementById('selectedEmployeeInputs');
                container.innerHTML = '';
                var count = 0;
                for (var i = 0; i < checkboxes.length; i++) {
                    if (checkboxes[i].checked) {
                        var input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'employeeIds';
                        input.value = checkboxes[i].value;
                        container.appendChild(input);
                        count++;
                    }
                }
                if (count > 0) {
                    new bootstrap.Modal(document.getElementById('bulkAssignModal')).show();
                }
            }

        </script>
    </div>
</body>

</html>