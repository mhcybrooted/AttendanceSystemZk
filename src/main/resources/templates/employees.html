<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Employee Management</title>
</head>

<body>
    <div th:replace="~{layout :: layout(~{::section}, ~{::script}, 'employees')}">
        <section>
            <div class="container-fluid">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h2>Employees</h2>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
                            + Add Employee
                        </button>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Photo</th>
                                    <th>ID (Device ID)</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Role</th>
                                    <th>Email</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="emp : ${employees}">
                                    <td>
                                        <img th:if="${emp.photoBase64 != null}"
                                            th:src="'data:image/jpeg;base64,' + ${emp.photoBase64}" width="50"
                                            height="50" class="rounded-circle" style="object-fit:cover;">
                                        <span th:if="${emp.photoBase64 == null}" class="text-muted">No IMG</span>
                                    </td>
                                    <td th:text="${emp.id}">1</td>
                                    <td th:text="${emp.name}">John Doe</td>
                                    <td th:text="${emp.department != null ? emp.department.name : 'Unassigned'}">
                                        Engineering
                                    </td>
                                    <td th:text="${emp.role}">Developer</td>
                                    <td th:text="${emp.email}">john@example.com</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm me-1" type="button" th:data-id="${emp.id}"
                                            th:data-name="${emp.name}" th:data-role="${emp.role}"
                                            th:data-email="${emp.email}"
                                            th:data-dept-id="${emp.department != null ? emp.department.id : ''}"
                                            onclick="editEmployee(this)">
                                            Edit
                                        </button>
                                        <a th:href="@{/employees/delete/{id}(id=${emp.id})}"
                                            class="btn btn-danger btn-sm"
                                            onclick="return confirm('Delete this employee?')">Delete</a>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(employees)}">
                                    <td colspan="6" class="text-center">No employees found. Add one to link names to
                                        attendance
                                        logs.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Add/Edit Employee Modal -->
                <div class="modal fade" id="addEmployeeModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form action="/employees" method="post">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="empModalTitle">Add Employee</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Device User ID (PIN)</label>
                                        <input type="text" class="form-control" id="empId" name="id" required
                                            placeholder="Important! Must match Device ID">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="empName" name="name"
                                            placeholder="John Doe" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Department</label>
                                        <select name="departmentId" id="empDept" class="form-select">
                                            <option value="">Select Department</option>
                                            <option th:each="dept : ${departments}" th:value="${dept.id}"
                                                th:text="${dept.name}">
                                            </option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Role</label>
                                        <input type="text" class="form-control" id="empRole" name="role"
                                            placeholder="Staff">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="empEmail" name="email"
                                            placeholder="john@example.com">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Login Password (Username)</label>
                                        <input type="text" class="form-control" id="empUsername" name="username"
                                            placeholder="Set password for employee login">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Save Employee</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <script>
            function editEmployee(btn) {
                var id = btn.getAttribute('data-id');
                var name = btn.getAttribute('data-name');
                var role = btn.getAttribute('data-role');
                var email = btn.getAttribute('data-email');
                var deptId = btn.getAttribute('data-dept-id');

                document.getElementById('empModalTitle').innerText = 'Edit Employee';
                document.getElementById('empId').value = id;
                document.getElementById('empId').readOnly = true; // Cannot change ID in edit
                document.getElementById('empName').value = name;
                document.getElementById('empRole').value = role;
                document.getElementById('empEmail').value = email;
                document.getElementById('empDept').value = deptId;
                new bootstrap.Modal(document.getElementById('addEmployeeModal')).show();
            }

            // Reset check (optional, or just rely on manual clear)
            document.getElementById('addEmployeeModal').addEventListener('hidden.bs.modal', function () {
                document.getElementById('empModalTitle').innerText = 'Add Employee';
                document.getElementById('empId').readOnly = false;
                document.getElementById('empId').value = '';
                document.getElementById('empName').value = '';
                document.getElementById('empRole').value = '';
                document.getElementById('empEmail').value = '';
                document.getElementById('empDept').value = '';
                document.getElementById('empUsername').value = ''; // Clear username
            });
            document.getElementById('empModalTitle').innerText = 'Add Employee';
            document.getElementById('empId').readOnly = false;
            document.getElementById('empId').value = '';
            document.getElementById('empName').value = '';
            document.getElementById('empRole').value = '';
            document.getElementById('empEmail').value = '';
            document.getElementById('empDept').value = '';

        </script>
    </div>
</body>

</html>